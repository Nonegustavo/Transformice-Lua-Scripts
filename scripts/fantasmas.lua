-- Script escrito em colaboração com o Esh#0095 em 2015

tfm.exec.disableAfkDeath(true)
tfm.exec.disableAutoShaman(true)
tfm.exec.disableAutoNewGame(true)

system.xml = [[<C><P Ca="" L="3000" H="734" D="x_evenements/x_fondHalloween.jpg" d="x_evenements/x_fondHalloween2.png" DS="m;196,694" /><Z><S><S P="0,0,0.3,0.2,0,0,0,0" L="1057" o="12bd94" H="344" Y="870" T="12" m="" X="1324" /><S P="0,0,20,0.2,0,0,0,0" L="323" o="12bd94" H="734" Y="368" T="12" m="" X="3156" /><S P="0,0,0,0.2,0,0,0,0" L="156" o="12bd94" H="734" Y="367" T="12" m="" X="-73" /><S P="0,0,0.3,0.2,0,0,0,0" L="580" o="12bd94" H="10" Y="398" T="12" m="" X="2421" /><S P="0,0,0.3,0.2,0,0,0,0" L="1000" o="12bd94" H="10" Y="481" T="12" m="" X="2394" /><S P="0,0,0.3,0.2,-30,0,0,0" L="50" o="12bd94" H="93" Y="726" T="12" m="" X="1888" /><S P="0,0,0.3,0.2,0,0,0,0" L="800" o="12bd94" H="336" Y="866" T="12" m="" X="401" /><S P="0,0,0.3,0.2,40,0,0,0" L="70" o="12bd94" H="101" Y="735" T="12" m="" X="1908" /><S P="0,0,0.3,0.2,0,0,0,0" L="30" o="12bd94" H="90" Y="718" T="12" m="" X="1900" /><S P="0,0,0.3,0.2,0,0,0,0" L="1048" o="12bd94" H="292" Y="858" T="12" m="" X="2474" /><S P="0,0,0.3,0.2,0,0,0,0" L="80" o="12bd94" H="10" Y="633" T="12" m="" X="2020" /><S P="0,0,0.3,0.2,0,0,0,0" L="80" o="12bd94" H="10" Y="597" T="12" m="" X="2258" /><S P="0,0,1,0.2,0,0,0,0" L="150" o="12bd94" H="20" Y="659" T="12" m="" X="2443" /><S P="0,0,0,0.2,-28,0,0,0" L="390" o="12bd94" H="10" Y="585" T="12" m="" X="2829" /><S P="0,0,0.3,0.2,0,0,0,0" L="170" o="12bd94" H="10" Y="603" T="12" m="" X="2445" /><S P="0,0,0.3,0.2,0,0,0,0" L="240" o="12bd94" H="10" Y="326" T="12" m="" X="2416" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="441" T="12" m="" X="2768" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="356" T="12" m="" X="2672" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="336" T="12" m="" X="2733" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="314" T="12" m="" X="2791" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="296" T="12" m="" X="2850" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="274" T="12" m="" X="2904" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="256" T="12" m="" X="2958" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="214" T="12" m="" X="2903" /><S P="0,0,0.3,0.2,0,0,0,0" L="890" o="12bd94" H="10" Y="244" T="12" m="" X="2389" /><S P="0,0,20,0.2,0,0,0,0" L="10" o="12bd94" H="160" Y="89" T="12" m="" X="2850" /><S P="0,0,0,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="181" T="12" m="" X="2731" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="98" T="12" m="" X="2790" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="59" T="12" m="" X="2738" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="129" T="12" m="" X="2606" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="73" T="12" m="" X="2479" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="194" T="12" m="" X="2430" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="119" T="12" m="" X="2305" /><S P="0,0,0.0,0.2,22,0,0,0" L="330" o="12bd94" H="10" Y="142" T="12" m="" X="2069" /><S P="0,0,0.3,0.2,0,0,0,0" L="310" o="12bd94" H="10" Y="67" T="12" m="" X="2167" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="70" Y="37" T="12" m="" X="2324" /><S P="0,0,0.3,0.2,0,0,0,0" L="50" o="12bd94" H="10" Y="80" T="12" m="" X="1893" /><S P="0,0,0,0.2,-35,0,0,0" L="240" o="12bd94" H="10" Y="147" T="12" m="" X="1773" /><S P="0,0,0.3,0.2,0,0,0,0" L="340" o="12bd94" H="10" Y="475" T="12" m="" X="1734" /><S P="0,0,0,0.2,0,0,0,0" L="40" o="12bd94" H="150" Y="545" T="12" m="" X="1545" /><S P="0,0,0.3,0.2,0,0,0,0" L="120" o="12bd94" H="20" Y="393" T="12" m="" X="1546" /><S P="0,0,0,0.2,0,0,0,0" L="70" o="12bd94" H="50" Y="264" T="12" m="" X="1531" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="313" T="12" m="" X="1107" /><S P="0,0,0,0.2,-5,0,0,0" L="40" o="12bd94" H="10" Y="213" T="12" m="" X="1666" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="260" Y="211" T="12" m="" X="1898" /><S P="0,0,0,0.2,-20,0,0,0" L="100" o="12bd94" H="20" Y="374" T="12" m="" X="995" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="486" T="12" m="" X="648" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="441" T="12" m="" X="2077" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="10" Y="429" T="12" m="" X="602" /><S P="0,0,0,0.2,-20,0,0,0" L="100" o="12bd94" H="20" Y="504" T="12" m="" X="430" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="496" T="12" m="" X="1028" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="413" T="12" m="" X="1167" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="481" T="12" m="" X="1286" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="20" Y="495" T="12" m="" X="1427" /><S P="0,0,0.3,0.2,0,0,0,0" L="10" o="12bd94" H="80" Y="514" T="12" m="" X="1899" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="551" T="12" m="" X="1899" /><S P="0,0,0.3,0.2,0,0,0,0" L="40" o="12bd94" H="10" Y="662" T="12" m="" X="85" /></S><D /><O><O X="1027" C="22" Y="471" P="0" /><O X="1167" C="22" Y="387" P="0" /><O X="1285" C="22" Y="455" P="0" /><O X="1425" C="22" Y="469" P="0" /><O X="1108" C="22" Y="282" P="0" /><O X="982" C="22" Y="346" P="0" /><O X="1682" C="22" Y="184" P="0" /><O X="1727" C="22" Y="153" P="0" /><O X="2276" C="22" Y="45" P="0" /><O C="22" Y="45" P="0" X="2301" /><O C="22" Y="25" P="0" X="2399" /><O P="0" C="22" Y="37" X="2424" /><O C="22" Y="29" X="2375" P="0" /><O C="22" Y="100" X="2306" P="0" /><O X="2606" C="22" Y="105" P="0" /><O X="2479" C="22" Y="50" P="0" /><O X="2738" C="22" Y="36" P="0" /><O X="2876" C="22" Y="38" P="0" /><O X="2370" C="22" Y="304" P="0" /><O X="2469" C="22" Y="304" P="0" /><O X="2422" C="22" Y="373" P="0" /><O X="2420" C="22" Y="449" P="0" /><O X="2444" C="22" Y="560" P="0" /><O X="2274" C="22" Y="580" P="0" /><O X="551" C="22" Y="649" P="0" /><O X="866" C="22" Y="648" P="0" /><O X="1276" C="22" Y="651" P="0" /><O X="120" C="22" Y="518" P="0" /><O X="418" C="22" Y="476" P="0" /><O X="140" C="22" Y="518" P="0" /><O X="120" C="22" Y="533" P="0" /><O X="140" C="22" Y="533" P="0" /><O X="603" C="22" Y="411" P="0" /><O X="1900" C="22" Y="650" P="0" /><O X="1615" C="22" Y="450" P="0" /><O X="2080" C="22" Y="416" P="0" /><O X="2533" C="22" Y="220" P="0" /><O X="1941" C="22" Y="62" P="0" /><O X="648" C="22" Y="456" P="0" /><O X="388" C="22" Y="486" P="0" /><O X="442" C="22" Y="467" P="0" /><O X="960" C="22" Y="355" P="0" /><O X="2349" C="22" Y="37" P="0" /><O X="85" Y="683" P="0" C="22" /><O X="83" Y="640" P="0" C="22" /><O X="291" Y="676" P="0" C="22" /><O X="1730" Y="674" P="0" C="22" /><O X="2036" Y="610" P="0" C="22" /><O X="1997" Y="609" P="0" C="22" /><O X="2487" Y="630" P="0" C="22" /><O X="2391" Y="630" P="0" C="22" /><O X="2973" Y="567" P="0" C="22" /><O X="2973" Y="594" P="0" C="22" /><O X="2973" Y="623" P="0" C="22" /><O X="1705" Y="167" P="0" C="22" /><O X="1976" Y="218" P="0" C="22" /><O X="2034" Y="218" P="0" C="22" /><O X="2135" Y="139" P="0" C="22" /><O X="2429" Y="170" P="0" C="22" /><O X="2874" Y="76" P="0" C="22" /><O X="1765" Y="449" P="0" C="22" /><O X="2416" Y="304" P="0" C="22" /><O X="2744" Y="592" P="0" C="22" /><O X="2956" Y="236" P="0" C="22" /><O X="2790" Y="292" P="0" C="22" /></O></Z></C>]]

system.objs = {}
system.coords = {}
system.cellscoords = {}
system.ghostsAlive =15
system.maxCells = 5
system.players = {}
system.cells = {}
system.image = {"1506c71212c.png", "1506c70c940.png"} -- [1] = right, [2] = left
system.imageBoo = "150cf0219de.png"
system.imageBattery = "150d2f9286d.png"
system.imagePlasma = {"150ceebcc9f.png", "150cef35c61.png", "150cef58c15.png", "150cef7750d.png", "150cef8f79d.png"}
system.imageEnergy = {"150ddad0043.png", "150ddb2d069.png", "150ddb444ab.png", "150ddb54337.png", "150ddb6b89b.png", "150ddbb343a.png"}
system.imageTuto = "150d9e213d6.png"
system.imageCannons = {"150d3ed7602.png","1507bd5e7a2.png"}
system.objective = 15
system.notEnd = true

system.imageEmoticon = {
	{"1507b848517.png", "1507b84ac5e.png", "1507b84cec7.png", "1507b84efbc.png", "1507b851bd6.png", "1507b853ce8.png", "1507b855b45.png", "1507b8579bd.png"},
	{"1507b859de8.png", "1507b85be47.png", "1507b85deda.png", "1507b85fd85.png", "1507b861fed.png", "1507b864792.png", "1507b8667fb.png", "1507b8689b6.png"},
}

for _, command in pairs({"666", "2013", "bonbon"}) do
	system.disableChatCommandDisplay(command, true)
end

system.tutos = {
	BR = {
		"Parece que o von teve problemas enquanto terminava os preparativos para o halloween! A sua mansão foi invadida pelos fantasmas e por isso não está apta a receber os ratinhos para o evento de halloween 2015! Para evitar mais desastres, a Buffy contratou seus amigos de caça ao sobrenatural: os caça-fantasmas !"
	},
}

system.traps = {}
system.imagemTimer = {}
system.ratosPresos = {}
system.playerLevel = {}


--------------------------------------- FUNÇÃO DE SALVAR JOGADORES ---------------------------------------
gameData = {
	players = {}
}


function string.split(pString, pPattern)
local Table = {} 
local fpat = "(.-)" .. pPattern
local last_end = 1
local s, e, cap = pString:find(fpat, 1)
	while s do
		if s ~= 1 or cap ~= "" then
			table.insert(Table,cap)
		end
		last_end = e+1
		s, e, cap = pString:find(fpat, last_end)
	end
	if last_end <= #pString then
		cap = pString:sub(last_end)
		table.insert(Table, cap)
	end
	return Table
end

function gameData.save(player, data)
	dataStr = ""
	if (gameData.players[player]) then
		for key, data in pairs(gameData.players[player]) do
			dataStr = dataStr..string.format("%s=%s¤",  key, data)
		end
	end
	return dataStr
end

function gameData.load(player, data)
	if (data) then
		gameData.players[player] = {}
		for key, data in pairs(string.split(data, "¤")) do
			data = string.split(data, "=")
			gameData.players[player][data[1]] = data[2]
		end
	end
end

--------------------------------------- FIM DA FUNÇÃO ---------------------------------------

function split(t,s)
	local a={}
	for i,v in string.gmatch(t,string.format("[^%s]+",s or "%s")) do
	table.insert(a,i)
	end
	return a
end

function criaImagem(u, a, x, y, t, p) -- função pronta pra criar imagem e definir seu timer
	local i = tfm.exec.addImage(u, a, x, y, p)
	if i then
	system.imagemTimer[i] = os.time()+t
	end
	return i
end

function apagaImagens() -- função que percorre a lista de imagens a serem removidas
	local apagar={}
	for i,v in pairs(system.imagemTimer) do
	if v<os.time() then
		table.insert(apagar,i)
	end
	end
	for i=1,#apagar do
	tfm.exec.removeImage(apagar[i])
	system.imagemTimer[apagar[i]]=nil
	end
end

function criaObjeto(o, x, y, a, t, g) -- função pronta pra criar objeto e definir seu timer
	local i = tfm.exec.addShamanObject(o, x, y, a or 0, 0, 0, g)
	system.traps[i] = os.time() + t
	return i
end

function apagaObjetos() -- função que percorre a lista de objetos a serem removidos
	local apagar={}
	for i,v in pairs(system.traps) do
	if v<os.time() then
		table.insert(apagar,i)
	end
	end
	for i=1,#apagar do
	tfm.exec.removeObject(apagar[i])
	system.traps[apagar[i]]=nil
	end
end

function eventNewGame()
	tfm.exec.addPhysicObject(0, 1500, -5, {width=3000})
	tfm.exec.setUIMapName("Haunted House")
end

function eventPlayerDataLoaded(player, data)
	-- supondo que não há dados
	if string.len(data) < 3 then
		data = "halloween2015_points=0¤"
	end
	gameData.load(player, data)
	if not (gameData.players[player].halloween2015_points) then
		gameData.players[player].halloween2015_points = 0
	end
	for i=1, 5 do
		ui.updateTextArea(i, gameData.players[player].halloween2015_points, player)
	end
end
 
function system.init()
	tfm.exec.newGame(system.xml)
	tfm.exec.setGameTime(140)
	system.loadPlaces()
	system.loadPlayers()
	system.loadGhosts()
	system.loadCells()
	ui.addTextArea(1, "<font color='#000000'><b>0", nil, 774, 379, nil, nil, 0, 0, 0, true)
	ui.addTextArea(2, "<font color='#000000'><b>0", nil, 776, 379, nil, nil, 0, 0, 0, true)
	ui.addTextArea(3, "<font color='#000000'><b>0", nil, 774, 381, nil, nil, 0, 0, 0, true)
	ui.addTextArea(4, "<font color='#000000'><b>0", nil, 776, 381, nil, nil, 0, 0, 0, true)
	ui.addTextArea(5, "<font color='#ffffff'><b>0", nil, 775, 380, nil, nil, 0, 0, 0, true)
	tfm.exec.addImage("1507b6ca8e2.png", "&10", 762, 380, nil)
	--tfm.exec.addImage("150bf351900.png", "?4", 1962, 508, nil)
	criaImagem(system.imageTuto, "&1", 160, 50, 6000, nil)
	for i, v in pairs(tfm.get.room.playerList) do
		--system.loadPlayerData(i)
    eventPlayerDataLoaded(i, "")
		system.bindMouse(i, true)
	end
end
 
function system.loadPlaces()
	system.coords = {}
	pointers = string.match(system.xml, "<S>(.+)</S>")
	for obj in string.gmatch(pointers, "<S([^/>]+)/>") do
		objX = string.match(obj, "X=\"([0-9-.]+)\"")+0
		objY = string.match(obj, "Y=\"([0-9-.]+)\"")+0
		objH = string.match(obj, "H=\"([0-9-.]+)\"")+0
		objL = string.match(obj, "L=\"([0-9-.]+)\"")+0
		objA = (split(string.match(obj, "P=\".-\""):sub(4,-2),","))[5]+0
		if objL > 30 and objA == 0 and objX > 0 and objX < 3000 then
			system.coords[#system.coords+1] = {objX, objY, objL, objH}
		end
	end
	pointers = string.match(system.xml, "<O>(.+)</O>")
	for obj in string.gmatch(pointers, "<O([^/>]+)/>") do
		objX = string.match(obj, "X=\"([0-9-.]+)\"")+0
		objY = string.match(obj, "Y=\"([0-9-.]+)\"")+0
		system.cellscoords[#system.cellscoords+1] = {objX, objY}
	end
end
 
function system.loadPlayers()
	for player, _ in pairs(tfm.get.room.playerList) do
		system.players[player] = {cells = 0, captured = 0, keytime = os.time(), gottencells = {}, imgcells={}, imgEnergy=false, trapped=os.time()}
		tfm.exec.bindKeyboard(player, 32, true, true)
		system.updatePlayerEnergy(player)
		system.playerLevel[player] = 0
	end
end
 
function system.loadGhosts()
	for ghost = system.ghostsAlive, 1, -1 do
		system.objs[ghost] = {object = "", image=0, alive = true, look = 1}
		coord = system.coords[math.random(#system.coords)]
		system.objs[ghost].object = tfm.exec.addShamanObject(6300, math.random(coord[1]-coord[3]/2, coord[1]+coord[3]/2), coord[2]-coord[4]/2, false, 0, 0, false)
	system.objs[ghost].image = tfm.exec.addImage(system.image[1], "#"..system.objs[ghost].object, -20, -35, nil)
	end
end
 
function system.loadCells()
	for mx = #system.cellscoords, 1, -1 do
		coo = mx
		coord = system.cellscoords[coo]
		if (coord ~= nil) then
			for p, v in pairs(system.players) do
				system.players[p].imgcells[mx] = tfm.exec.addImage(system.imageBattery, "?100", coord[1]-15, coord[2]-15, p)
			end
			system.cells[mx] = {x = coord[1], y = coord[2], id = mx}
		end
	end
end
 
function system.moveGhost(id, teleport, index)
	if teleport then
		rand = math.random(#system.coords)
		coord = system.coords[rand]
		if (coord ~= nil) then
		pos = tfm.get.room.objectList[id]
		if (pos ~= nil)then
		for x = 4, 0, -1 do
			tfm.exec.displayParticle(3, pos.x+math.random(-5, 5), pos.y+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
		end
		px = math.random(coord[1]-coord[3]/2, coord[1]+coord[3]/2-15)
		py = coord[2]-coord[4]/2,
		tfm.exec.moveObject(id, px, py, false, 0, 0, true)
		for x = 4, 0, -1 do
			tfm.exec.displayParticle(3, px+math.random(-5, 5), py+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
		end
		if px < 0 or px > 3000 or py < 0 then
			tfm.exec.chatMessage(string.format("Teleport irregular: Piso %d, x = %d, y = %d, l = %d, h = %d", rand, coord[1], coord[2], coord[3], coord[4]))
		end
		end
		end
	else
		velx = math.random(-50, 50)
		if velx > 0 then
			system.objs[index].look = 1
		elseif velx < 0 then
			system.objs[index].look = 2
		end
		tfm.exec.addImage(system.image[system.objs[index].look], "#"..id, -20, -35, nil)
		tfm.exec.moveObject(id, 0, 0, false, velx, math.random(-70, 0), true)
	end
end

function system.movePlayer(p)
	coord = system.coords[math.random(#system.coords)]
	if (coord ~= nil) then
		pos = tfm.get.room.playerList[p]
		if (pos ~= nil)then
			for x = 4, 0, -1 do
				tfm.exec.displayParticle(3, pos.x+math.random(-5, 5), pos.y+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
			end
			px = math.random(coord[1]-coord[3]/2, coord[1]+coord[3]/2-15)
			py = coord[2]-coord[4]/2,
			tfm.exec.movePlayer(p, px, py, false, 0, 0, true)
			for x = 4, 0, -1 do
				tfm.exec.displayParticle(3, px+math.random(-5, 5), py+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
			end
		end
	end
end
 
function system.removeGhost(index, id)
	tfm.exec.removeObject(id)
	system.objs[index] = nil
end
 
function system.meepGhost(id)
	coord = tfm.get.room.objectList[id]
	if (coord ~= nil) then
		tfm.exec.addShamanObject(24, coord.x, coord.y, false, 0, 0, false)
		tfm.exec.displayParticle(20, coord.x, coord.y, 0.11, -0.11, 0, 0, nil)
	end
end
 
function system.updatePlayerEnergy(player)
	cells = system.players[player].cells
	local cont = 1
	for mx = system.maxCells, 1, -1 do
		cells = cells-1
		if (cells >= 0) then
			cont = cont + 1
		end
	end
	if system.players[player].imageEnergy then
		tfm.exec.removeImage(system.players[player].imageEnergy)
	end
	system.players[player].imageEnergy = tfm.exec.addImage(system.imageEnergy[cont], "$"..player, -43, -48, player)
end

function playerIndefesoProximo(object, dist) -- retorna o jogador indefeso mais próximo do fantasma
	local nome = false
	local distancia = dist
	local o = tfm.get.room.objectList[object]
	for i, v in pairs(tfm.get.room.playerList) do
		local novaDistancia = not v.isDead and o and v and o.x and o.y and v.x and v.y and math.sqrt((v.x-o.x)^2+(v.y-o.y)^2) or math.huge
		if novaDistancia < distancia and system.players[i] and system.players[i].cells < 5 and os.time() > system.players[i].trapped then
			nome = i
			distancia = novaDistancia
		end
	end
	return nome
end

function playerArmadoProximo(object, dist) -- retorna o jogador armado mais próximo do fantasma
	local nome = false
	local distancia = dist
	local o = tfm.get.room.objectList[object]
	for i, v in pairs(tfm.get.room.playerList) do
		local novaDistancia = not v.isDead and o and v and o.x and o.y and v.x and v.y and math.sqrt((v.x-o.x)^2+(v.y-o.y)^2) or math.huge
		if novaDistancia < distancia and system.players[i] and system.players[i].cells == 5 then
			nome = i
			distancia = novaDistancia
		end
	end
	return nome
end

function playerArmadoDireita(object) -- retorna um jogador armado à direita
	local nome = false
	local o = tfm.get.room.objectList[object]
	for i, v in pairs(tfm.get.room.playerList) do
		if not v.isDead and o and v and o.x and o.y and v.x and v.y and math.abs(v.y-o.y) < 20 and v.x-o.x < 200 and v.x-o.x > 0 and system.players[i] and system.players[i].cells == 5 then
			nome = i
		end
	end
	return nome
end

function playerArmadoEsquerda(object) -- retorna um jogador armado à esquerda
	local nome = false
	local o = tfm.get.room.objectList[object]
	for i, v in pairs(tfm.get.room.playerList) do
		if not v.isDead and o and v and o.x and o.y and v.x and v.y and math.abs(v.y-o.y) < 20 and o.x-v.x < 200 and o.x-v.x > 0 and system.players[i] and system.players[i].cells == 5 then
			nome = i
		end
	end
	return nome
end

function eventPlayerDied(p)
	local i = #system.objs+1
	system.objs[i] = {object = "", image=0, alive = true, look = 1}
	coord = tfm.get.room.playerList[p]
	system.objs[i].object = tfm.exec.addShamanObject(6300, coord.x, coord.y, false, 0, 0, false)
	system.objs[i].image = tfm.exec.addImage(system.image[1], "#"..system.objs[i].object, -20, -35, nil)
	for x = 10, 0, -1 do
		tfm.exec.displayParticle(13, coord.x+math.random(-5, 5), coord.y+math.random(-5, 5), math.random(-2.11, 2.11), math.random(-2.11, 2.11), 0, 0, nil)
	end
end

function eventLoop(current, remaining)
	for key, ghost in pairs(system.objs) do
		local armadoPerto = playerArmadoProximo(ghost.object, 40)
		if armadoPerto and math.random(1,3) == 1 then
			local armadoPerto = playerArmadoProximo(ghost.object, 40)
			if math.random(1,2) then
				-- spirit
				system.meepGhost(ghost.object)
				tfm.exec.addImage(system.imageEmoticon[ghost.look][8], "#"..ghost.object, -20, -48)
			else
				-- fantasma teleporta
				system.moveGhost(ghost.object, true)
			end
		else
			local direita = playerArmadoDireita(ghost.object)
			if direita and math.random(1,4) == 1 then
			-- cannon direita
			system.ghostCannon(ghost, math.random(45,90))
			else
			local esquerda = playerArmadoEsquerda(ghost.object)
			if esquerda and math.random(1,4) == 1 then
				-- cannon esquerda
				system.ghostCannon(ghost, math.random(-90,-45))
			else
				local armadoLonge = playerArmadoProximo(ghost.object, 200)
				if armadoLonge and	math.random(1,2) == 1 then
				-- fugir
				system.ghostRunning(ghost , armadoLonge)
				else
				local indefesoPerto = playerIndefesoProximo(ghost.object, 20)
				if indefesoPerto and math.random(1,4) > 1 then
					-- ataca jogador
					system.ghostAttack(ghost, indefesoPerto)
				else
					local indefesoLonge = playerIndefesoProximo(ghost.object, 200)
					if indefesoLonge and math.random(1,2) == 1 then
					-- seguir
					system.ghostFollowing(ghost, indefesoLonge)
					elseif math.random(1,15) == 1 then
					-- teleportar
					system.moveGhost(ghost.object, true)
					elseif math.random(1,2) == 1 then
					-- andar
					system.moveGhost(ghost.object, false, key)
					end
				end
				end
			end
			end
		end
	end
	if remaining < 0  and system.notEnd then
		tfm.exec.addImage(system.imageBoo, "&1000", 0, 0, player)
		system.newTimer(function () system.exit() end, 2000)
		system.notEnd = true
	end
	apagaObjetos()
	apagaImagens()
end

function eventMouse(player, posX, posY)
	if system.checkinrange(1700, 700, posX, posY, 30) then
		--[[ monstros ]]--
		criaImagem("15078cea557.png", "?4", 0, 0, 2000, player)
		
	elseif system.checkinrange(2025, 622, posX, posY, 100) then
		--[[ Quadro do von ]]--
		criaImagem("150d8b887a0.png", "?4", 1962, 508, 2000, player)
	
	elseif system.checkinrange(2445, 622, posX, posY, 50) and system.playerLevel[player] == 4 then
		--[[ Prateleira ]]--
		criaImagem("150d9d0381d.png", "?4", 0, 0, 7200, player)
		criaImagem("150d9dc47ad.png", "&4", 0, 0, 6000, player)
	
	elseif system.checkinrange(1420, 491, posX, posY, 50) and system.playerLevel[player] == 1 then
		--[[ Abobora ]]--
		tfm.exec.chatMessage("<i>I am the one hiding under your's stairs</i>", player)
		system.playerLevel[player] = 2
	
	elseif system.checkinrange(2970, 590, posX, posY, 50) and system.playerLevel[player] == 2 then
		--[[ Escadaria ]]--
		tfm.exec.chatMessage("<i>I am the shadow on the moon at night</i>", player)
		system.playerLevel[player] = 3
	
	elseif system.checkinrange(posX, posY, 379, 441, 100) and system.playerLevel[player] == 3 then
		--[[ Lua ilumina ]]--
		criaImagem("150d9bf6134.png", "_4", 0, 0, 12000, player)
		system.playerLevel[player] = 4
	end
end

function eventChatCommand(player, command)
	if (command == "666" and system.playerLevel[player] == 0) then
		tfm.exec.chatMessage("<i>Pumpkins scream in the dead of night</i>", player)
		system.playerLevel[player] = 1
	end
end

function system.ghostAttack(ghost, player) -- o fantasma ataca um jogador
	local n = math.random(1,4)
	local p = tfm.get.room.playerList[player]
	if n == 1 then
	-- rato teleporta
	ui.addTextArea(0, "", player, 0, 0, 800, 400, 1, 1, 1, true)
	local img = tfm.exec.addImage(system.imageBoo, "&1", 0, 0, player)
	system.movePlayer(player)
	system.newTimer(function()
		ui.removeTextArea(0, player)
		ui.removeTextArea(-1, player)
		tfm.exec.removeImage(img)
	end, 1000, false)
	elseif n == 2 then
		-- prende em caixa
		local idObj = criaObjeto(6100, p.x, p.y-1, 0, 5000, false)
		tfm.exec.addImage("15081a27483.png", "#"..idObj, -31, -31)
		tfm.exec.movePlayer(player, p.x, p.y, false, 0, 0, false)
	elseif n == 3 then
	-- prende em triangulo
		local idObj = criaObjeto(68, p.x, p.y, 0, 5000, false)
		criaObjeto(2800, p.x, p.y, 0, 5000, true)
		tfm.exec.addImage("150dd9e8b5d.png", "#"..idObj, -48, -48)
		tfm.exec.movePlayer(player, p.x, p.y, false, 0, 0, false)
	elseif n == 4 then
	-- suja a tela
		for i=1, 5 do
			criaImagem(system.imagePlasma[math.random(#system.imagePlasma)], "&1", math.random(-100, 690), math.random(-100, 300), 10000, player)
		end
		for x = 1, 40 do
			tfm.exec.displayParticle(14, p.x, p.y, math.random(-20, 20)/5, math.random(-30, 10)/5, 0, 0.2, nil)
		end
	end
	system.players[player].trapped = os.time() + 5000
	local emoticon = {5, 6}
	tfm.exec.addImage(system.imageEmoticon[ghost.look][emoticon[math.random(#emoticon)]], "#"..ghost.object, -20, -48)
	system.newTimer(function()
		system.moveGhost(ghost.object, true)
	end, 1000, false)
end

function system.ghostCannon(ghost, angulo) -- o fantasma dispara cannon
local idObj = criaObjeto(1700, tfm.get.room.objectList[ghost.object].x+20, tfm.get.room.objectList[ghost.object].y, angulo, 2000, false)
img = system.imageCannons[math.random(#system.imageCannons)]
tfm.exec.addImage(img, "#"..idObj, -26, -26)
tfm.exec.addImage(system.imageEmoticon[ghost.look][4], "#"..ghost.object, -20, -48)
end

function system.ghostRunning(ghost ,player) -- o fantasma se afasta de um jogador
local p = tfm.get.room.playerList[player]
local o = tfm.get.room.objectList[ghost.object]
tfm.exec.moveObject(ghost.object, 0, 0, true, (o.x-p.x)*math.random(), (o.y-p.y)-0.5)
local emoticon = {1, 3, 7}
	if o.y-p.y > 0 then
		ghost.look = 1
	elseif o.y-p.y < 0 then
		ghost.look = 2
	end
	tfm.exec.addImage(system.imageEmoticon[ghost.look][2], "#"..ghost.object, -20, -48)
end

function system.ghostFollowing(ghost ,player) -- o fantasma segue um jogador
local p = tfm.get.room.playerList[player]
local o = tfm.get.room.objectList[ghost.object]
tfm.exec.moveObject(ghost.object, 0, 0, true, (p.x-o.x)/2, (p.y-o.y)-0.5)
local emoticon = {1, 3, 7}
	if p.x-o.x > 0 then
		ghost.look = 1
	elseif p.x-o.x < 0 then
		ghost.look = 2
	end
tfm.exec.addImage(system.imageEmoticon[ghost.look][emoticon[math.random(#emoticon)]], "#"..ghost.object, -20, -48)
end
 
function system.checkNearGhost(posX, posY, player)
	nearGhost = false
	for key, ghost in pairs(system.objs) do
		coord = tfm.get.room.objectList[ghost.object]
		if (coord ~= nil) then
			if (system.checkinrange(posX, posY, coord.x, coord.y, 60) and system.players[player].cells == system.maxCells) then
				nearGhost = {key, ghost.object}
				break
			end
		end
	end
	return nearGhost
end
 
function system.checkNearCell(posX, posY, player)
	nearCell = false
	if (system.players[player].cells <= system.maxCells) then
		for key, cell in pairs(system.cells) do
			if (system.checkinrange(posX, posY, cell.x, cell.y, 30)) then
				nearCell = key
			end
		end
	end
	return nearCell
end
 
function system.checkinrange(posx, posy, posx2, posy2, range)
	return ((posx - posx2)^2 + (posy - posy2)^2 < range^2)
end

function system.checkinrange(posx, posy, posx2, posy2, range) -- uma alternativa da função
	return posx > posx2 - range and posx < posx2 + range and posy > posy2 - range and posy < posy2 + range	
end
 
function eventKeyboard(player, keyid, down, posX, posY)
	if (system.players[player].keytime < os.time()-500) and not tfm.get.room.playerList[player].isDead then
		system.players[player].keytime = os.time()
		hasGhost = system.checkNearGhost(posX, posY, player)
		if (hasGhost) then
			system.players[player].cells = 0
			system.updatePlayerEnergy(player)
			system.removeGhost(hasGhost[1], hasGhost[2])
			for x = 6, 0, -1 do
				tfm.exec.displayParticle(7, posX+math.random(-5, 5), posY+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
			end
			gameData.players[player].halloween2015_points = gameData.players[player].halloween2015_points + 1
			for i=1, 5 do
				ui.updateTextArea(i, gameData.players[player].halloween2015_points, player)
			end
			-- Supondo que não há dados
			--system.savePlayerData(player, gameData.save(player))
			if gameData.players[player].halloween2015_points == system.objective then
				system.giveEventGift(player, "")
			end
		else
			if (system.players[player].cells < system.maxCells) then
				hasCell = system.checkNearCell(posX, posY, player)
				if (hasCell) then
					if (system.players[player].gottencells[hasCell] == nil) then
						system.players[player].cells = system.players[player].cells+1
						--ui.removeTextArea(hasCell, player)
						tfm.exec.removeImage(system.players[player].imgcells[hasCell])
						system.updatePlayerEnergy(player)
						system.players[player].gottencells[hasCell] = true
						for x = 3, 0, -1 do
							tfm.exec.displayParticle(9, posX+math.random(-5, 5), posY+math.random(-5, 5), math.random(-1.11, 1.11), math.random(-1.11, 1.11), 0, 0, nil)
						end
					end
				end
			end
			
		end
	end
end
system.init()